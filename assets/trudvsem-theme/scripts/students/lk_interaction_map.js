!function(){var p,f,c,d,s,t,u,g="NOTIFICATIONS",n="SUCCESS",o="_im_cooperation",a="_im_contracts",h="",w=!1,r={},m={dataSourceId:"",dataVersion:"",sortId:"",id:""},l={dataSourceId:"",dataVersion:"",sortId:"",id:""},v=window.location.href,y=!1;function I(){var t=[c,d,s].filter(function(t){return t&&t!==u}),e={id_cooperation:window.cooperation_id,date:Date.now(),reading_marker:!1,text:"",id_student:c,id_institution:s,id_employer:d},t=t.map(function(t){return sendNotification(t,e)});return $.when.apply($,t)}function i(){getCatalogData("COOPERATION",{id:[window.cooperation_id]}).done(function(t){var e,n,o,a,i,t=t.result.data&&t.result.data.length&&t.result.data[0];t&&t.length?(n=t[1],o=t[19],a=t[18],i=!t[4]||!t[28]||t[20],e="Партнерское соглашение"==n&&o&&a,n="Партнерское соглашение"!=n&&o&&a&&i,o=$(".select__control[name=partner-type-select]").val(),a=Date.now(),e||n?$.when(e&&(i=[(i={id_contract:t[3][0],contract_date:a,validity:t[3][13],id_employer:t[6][0],id_institution:t[5][0],partnership_status:"Активный",partnership_type:o}).id_contract,i.contract_date,i.validity,i.id_employer,i.id_institution,i.partnership_status,i.partnership_type],i="//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/create?code=PARTNERSHIP&data="+encodeURIComponent(JSON.stringify(i))+"&unique_request_identifier="+_.uniqueId("PC_"),$.ajax({url:i,dataType:"json",contentType:"application/json",method:"POST"})),setFields(h,m,{contract_concluded:a,status:"Заключен"}),setFields(h,l,{contract_date:a})):setFields(h,m,{status:"На подписании"})):F()})}function C(){var t,e,n=[],o=$(".upload__control[name=contract_file]"),a=$(".select__control[ref=institute_rating]").val(),i=$(".select__control[ref=employer_rating]").val(),r=$(".text__control[name=description]").val(),l=$(".text__control[name=employer_comment]").val(),c=$(".text__control[name=education_comment]").val(),d=$(".select__control[name=partner-type-select]").val(),s=(console.log("--- form data ---"),console.log("fileInput:",o),console.log("selectInputE:",i),console.log("selectInputI:",a),console.log("employerReview:",r),console.log("employerComment:",l),console.log("institutionCommen:",c),console.log("partnershipType:",d),"Работодатель"===f),u="Учебное заведение"===f;m.id=window.cooperation_id,m.sortId=window.cooperation_id,console.log(m),console.log(m),w&&o.get(0).files.length&&n.push((o=o.get(0).files,t=p,(e=new FormData).append("typeCode","studDoc"),e.append("attachExtId",createUUID1()),e.append("file",o[0]),e.append("systemCode","intern"),e.append("extId",t),$.ajax({url:"/api/archive/storeAttachment",data:e,contentType:!1,processData:!1,type:"POST"}).then(function(){return console.log("FILE ATTACHED")}).catch(function(t){return console.err(t)}))),s&&r&&n.push(setFields(h,m,{employer_review:r})),s&&l&&n.push(setFields(h,m,{comment_employer:l})),u&&c&&n.push(setFields(h,m,{comment_educational:c})),u&&d&&n.push(setFields(h,m,{partnership_type:d})),a&&n.push(setFields(h,m,{institution_rating:a,institution_rating_setting:Date.now()})),i&&n.push(setFields(h,m,{employer_rating:i,employer_rating_setting:Date.now()})),n.length&&$.when.apply($,n).then(I).then(F).catch(O)}function e(t,e){$("#contract_appruve_info .modal__footer .button").on("click",function(){l.id=window.contract_id,l.sortId=window.contract_id,m.id=window.cooperation_id,m.sortId=window.cooperation_id,$.when(setFields(h,l,t),setFields(h,m,e)).then(i).then(I).then(F).catch(O)})}function F(){window.location.reload(!0)}function O(t){console.error(t)}function S(t){var e=t.result.code;if(e!==n)throw new Error("Bad request code:",e);return t}currentUserFull?(u=currentUserFull.id,t=Object.values(currentUserFull&&currentUserFull.roles||{}),f=t.length?t[0]:"USER_ROLE_UNKNOWN",console.log("userId:",u),console.log("userRole:",f),$(document).on("htmltextjs:rended",function(t,e){var a,n=window.cooperation_id||v.slice(v.indexOf("=")+1),e=$("#"+e),i=e.hasClass("interact-form")?e:null,r=$(".file-preview[data-file]");if(!i)return!1;function o(){l.removeAttr("disabled")}var l=$("[ref=save-data]",i);$("[name=partner-type-select]").on("change",o),$(".text__control, .select__control",i).on("change",o),y||(y=!0,$(".select__control").select2(),console.log("cooperatinId",n),n||console.error("cooperationId is not defined"),getCatalogData("COOPERATION",{id:n}).then(S).then(function(t){var e=t.result.data,t=(t.result.code,e[0]),e=t[4],n=t[5],t=t[6];c=e&&e[0],s=n&&n[0],d=t&&t[0]}).catch(O).then(function(){console.log("studentId:",c),console.log("institutionId",s),console.log("employerId",d)}),function(t,e){return getCatalogData(g,{id_recipient:t,id_cooperation:e,reading_marker:!1}).then(S).then(function(t){return t.result.data})}(u,n).then(function(t){var e=t.map(function(t){return t[0]});return console.log("notifications:",t),e}).then(function(t){return 0<t.length?(t=t.map(function(t){(function(t,e,n){e={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/updateFields?code="+e.toUpperCase()+"&id="+t+"&unique_request_identifier="+_.uniqueId("PC_")+"&version=1.2",dataType:"json",contentType:"application/json",method:"POST",data:JSON.stringify(n)};return $.ajax(e)})(t,g,{reading_marker:!0}).catch(O)}),$.when.apply($,t)):$.Deferred(function(){this.resolve()})}).catch(O).then(function(){console.log("Mark notifications readed: done")})),i&&getCatalogData("COOPERATION",{id:[window.cooperation_id]}).done(function(t){var t=t.result.data&&t.result.data.length&&t.result.data[0],e=t[14],n=t[13],o=t[29];t&&t.length&&($(".select__control[ref=institute_rating]",i).val(e),$(".select__control[ref=employer_rating]",i).val(n),$(".select__control[name=partner-type-select]").val(o).trigger("change"))}),!w&&r.length&&(a=r.closest("[data-uid]"),p=r.data("file"),getFileEnum(p).then(function(t){var e,n,o;t&&t.attachs&&t.attachs.length?(w=!0,1<t.attachs.length?((o=$(".file-preview__container").css("display","auto")).empty(),t.attachs.forEach(function(t){t.extId===p?(e="/api/archive/download/"+t.file,n=t.fileName):o.append("<a class='file-preview file-preview_vertical link' target='_blank' href='/api/archive/download/"+t.file+"'>"+t.fileName+"</a>")}),o.css("display","flex")):(e="/api/archive/download/"+t.attachs[0].file,n=t.attachs[0].fileName)):(console.warn("Карта взаимодействия без договора"),e=p,n="Договор отсутствует"),r.text(n),$("a[ref=file-download]",a).attr("href",e),$("a[ref=file-download]",a).attr("target","_blank")}).catch(O)),l.length&&($(".upload__control[type=file]").off("change").on("change",function(){var t=$(this);t.get(0).files.length&&t.closest("label.upload").find(".upload__file").text(t.get(0).files[0].name),o()}),l.off("click").on("click",C))}),new bft_JoinSource({sources:[o,a],initHandler:function(t){var e=t[o],t=t[a],e=e.url.split("/getData/");h=e[0],e=e[1].split("/"),m.dataSourceId=e[0],m.dataVersion=e[1],e=(e=t.url.split("/getData/"))[1].split("/"),l.dataSourceId=e[0],l.dataVersion=e[1]},handler:null}),window.coopeationPageViewed=function(){getCatalogData("COOPERATION",{id:[window.cooperation_id]}).done(function(t){var e,n,o,t=t.result.data&&t.result.data.length&&t.result.data[0];t&&t.length&&"Новый"==t[15]&&(e="Учебное заведение"==Object.values(currentUserFull.roles)[0],n=Boolean(t[2]&&t[2][8]),o="Работодатель"==Object.values(currentUserFull.roles)[0],t=Boolean(t[2]&&t[2][9]),n&&e||t&&o)&&(m.id=window.cooperation_id,m.sortId=window.cooperation_id,setFields(h,m,{view_changes:!0}))})},window.getActionSpace=function(t,e){return getCatalogData("ACTIVITY_AREA",{code:[t]}).then(function(t){$(e).text(_.last(t.result.data[0]))}).catch(O)},window.getProffesion=function(t,e){return getCatalogData("DEMANDED_PROFESSIONS",{code:[t]}).then(function(t){$(e).text(t.result.data[0][3])}).catch(O)},window.initStudentSelect=function(t,o,e,n){var a=$("#sSchoolStudents"),i=n.split(","),n={id_institution:t||"1111111111111111111111111111111"};$("[name=required_sign]","#change_student").prop("checked",e),getCatalogData("STUDENT",n).done(function(t){var e=[],n=[o];(t.result.data||[]).forEach(function(t){r[t[0]]=t[1],-1<i.indexOf(t[1])&&n.push(t[0]),e.push({id:t[0],text:t[1]})}),a.select2({data:e}).val(n).trigger("change"),a.on("change",function(){var t=$("input[name=required_sign]"),e=a.val();_.isArray(e)&&1<e.length?(t.removeAttr("checked"),t.attr("disabled","disabled")):t.removeAttr("disabled")})}).catch(O)},window.initStudentChangeForm=function(){$("#change_student .modal__footer .button").on("click",function(){var t=$("#change_student"),e=$("select",t).val(),n=null,n=(_.isArray(e)&&(n=_.range(1,e.length).map(function(t){return r[e[t]]}),e=e[0]),{id_student:e,students:n,required_student_signature:!_.isArray(n)&&$("[name=required_sign]",t).is(":checked")});l.id=window.contract_id,l.sortId=window.contract_id,m.id=window.cooperation_id,m.sortId=window.cooperation_id,$.when(setFields(h,l,n),setFields(h,m,n)).then(I).then(F).catch(O)})},window.initApproveContractEmployer=function(){e({employer_signature:!0},{employer_signature:Date.now()})},window.initApproveContractSchool=function(){e({institution_signature:!0},{institution_signature:Date.now()})},window.initApproveContractStudent=function(){e({student_signature:!0},{student_signature:Date.now()})}):console.error("currentUserFull is not defined")}();