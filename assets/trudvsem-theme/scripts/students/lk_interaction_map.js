!function(){var t,e,n,o,a,i,r,c="PARTNERSHIP",l="NOTIFICATIONS",d="COOPERATION",s="SUCCESS",u="_im_cooperation",p="_im_contracts",f="",g=!1,h={},w={dataSourceId:"",dataVersion:"",sortId:"",id:""},m={dataSourceId:"",dataVersion:"",sortId:"",id:""},v=window.location.href,y=!1;currentUserFull?(e=currentUserFull.id,r=Object.values(currentUserFull&&currentUserFull.roles||{}),n=r.length?r[0]:"USER_ROLE_UNKNOWN",console.log("userId:",e),console.log("userRole:",n),$(document).on("htmltextjs:rended",(function(n,r){var c,s=window.cooperation_id||v.slice(v.indexOf("=")+1),u=$("#"+r),p=u.hasClass("interact-form")?u:null,f=$(".file-preview[data-file]");if(!p)return!1;var h=$("[ref=save-data]",p),w=function(){h.removeAttr("disabled")};$("[name=partner-type-select]").on("change",w),$(".text__control, .select__control",p).on("change",w),y||(y=!0,$(".select__control").select2(),console.log("cooperatinId",s),s||console.error("cooperationId is not defined"),function(t){var e={id:t};return getCatalogData(d,e).then(A).then((function(t){var e,n,r,c,l=t.result.data;t.result.code;n=(e=l[0])[4],r=e[5],c=e[6],o=n&&n[0],i=r&&r[0],a=c&&c[0]})).catch(D)}(s).then((function(){console.log("studentId:",o),console.log("institutionId",i),console.log("employerId",a)})),function(t,e){return function(t,e){var n={id_recipient:t,id_cooperation:e,reading_marker:!1};return getCatalogData(l,n).then(A).then((function(t){return t.result.data}))}(t,e).then((function(t){var e=t.map((function(t){return t[0]}));return console.log("notifications:",t),e})).then((function(t){var e;return t.length>0?(e=t.map((function(t){!function(t,e){(function(t,e,n){var o="//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/updateFields?code="+e.toUpperCase()+"&id="+t+"&unique_request_identifier="+_.uniqueId("PC_")+"&version=1.2",a={url:o,dataType:"json",contentType:"application/json",method:"POST",data:JSON.stringify(n)};return $.ajax(a)})(t,l,e).catch(D)}(t,{reading_marker:!0})})),$.when.apply($,e)):$.Deferred((function(){this.resolve()}))})).catch(D)}(e,s).then((function(){console.log("Mark notifications readed: done")}))),p&&getCatalogData("COOPERATION",{id:[window.cooperation_id]}).done((function(t){var e=t.result.data&&t.result.data.length&&t.result.data[0],n=e[14],o=e[13],a=e[29];e&&e.length&&($(".select__control[ref=institute_rating]",p).val(n),$(".select__control[ref=employer_rating]",p).val(o),$(".select__control[name=partner-type-select]").val(a).trigger("change"))})),!g&&f.length&&(c=f.closest("[data-uid]"),t=f.data("file"),getFileEnum(t).then((function(e){var n,o,a;e&&e.attachs&&e.attachs.length?(g=!0,e.attachs.length>1?((a=$(".file-preview__container").css("display","auto")).empty(),e.attachs.forEach((function(e){e.extId===t?(n="/api/archive/download/"+e.file,o=e.fileName):a.append("<a class='file-preview file-preview_vertical link' target='_blank' href='/api/archive/download/"+e.file+"'>"+e.fileName+"</a>")})),a.css("display","flex")):(n="/api/archive/download/"+e.attachs[0].file,o=e.attachs[0].fileName)):(console.warn("Карта взаимодействия без договора"),n=t,o="Договор отсутствует"),f.text(o),$("a[ref=file-download]",c).attr("href",n),$("a[ref=file-download]",c).attr("target","_blank")})).catch(D)),h.length&&($(".upload__control[type=file]").off("change").on("change",(function(){var t=$(this);t.get(0).files.length&&t.closest("label.upload").find(".upload__file").text(t.get(0).files[0].name),w()})),h.off("click").on("click",F))})),new bft_JoinSource({sources:[u,p],initHandler:function(t){var e=t[u],n=t[p],o=e.url.split("/getData/");f=o[0],o=o[1].split("/"),w.dataSourceId=o[0],w.dataVersion=o[1],o=(o=n.url.split("/getData/"))[1].split("/"),m.dataSourceId=o[0],m.dataVersion=o[1]},handler:null}),window.coopeationPageViewed=function(){getCatalogData("COOPERATION",{id:[window.cooperation_id]}).done((function(t){var e=t.result.data&&t.result.data.length&&t.result.data[0];if(e&&e.length&&"Новый"==e[15]){var n="Учебное заведение"==Object.values(currentUserFull.roles)[0],o=Boolean(e[2]&&e[2][8]),a="Работодатель"==Object.values(currentUserFull.roles)[0],i=Boolean(e[2]&&e[2][9]);(o&&n||i&&a)&&(w.id=window.cooperation_id,w.sortId=window.cooperation_id,setFields(f,w,{view_changes:!0}))}}))},window.getActionSpace=function(t,e){return getCatalogData("ACTIVITY_AREA",{code:[t]}).then((function(t){$(e).text(_.last(t.result.data[0]))})).catch(D)},window.getProffesion=function(t,e){return getCatalogData("DEMANDED_PROFESSIONS",{code:[t]}).then((function(t){$(e).text(t.result.data[0][3])})).catch(D)},window.initStudentSelect=function(t,e,n,o){var a=$("#sSchoolStudents"),i=o.split(","),r={id_institution:t||"1111111111111111111111111111111"};$("[name=required_sign]","#change_student").prop("checked",n),getCatalogData("STUDENT",r).done((function(t){var n=[],o=[e];(t.result.data||[]).forEach((function(t){h[t[0]]=t[1],i.indexOf(t[1])>-1&&o.push(t[0]),n.push({id:t[0],text:t[1]})})),a.select2({data:n}).val(o).trigger("change"),a.on("change",(function(){var t=$("input[name=required_sign]"),e=a.val();_.isArray(e)&&e.length>1?(t.removeAttr("checked"),t.attr("disabled","disabled")):t.removeAttr("disabled")}))})).catch(D)},window.initStudentChangeForm=function(){$("#change_student .modal__footer .button").on("click",(function(){var t=$("#change_student"),e=$("select",t).val(),n=null;_.isArray(e)&&(n=_.range(1,e.length).map((function(t){return h[e[t]]})),e=e[0]);var o={id_student:e,students:n,required_student_signature:!_.isArray(n)&&$("[name=required_sign]",t).is(":checked")};m.id=window.contract_id,m.sortId=window.contract_id,w.id=window.cooperation_id,w.sortId=window.cooperation_id,$.when(setFields(f,m,o),setFields(f,w,o)).then(I).then(S).catch(D)}))},window.initApproveContractEmployer=function(){O({employer_signature:!0},{employer_signature:Date.now()})},window.initApproveContractSchool=function(){O({institution_signature:!0},{institution_signature:Date.now()})},window.initApproveContractStudent=function(){O({student_signature:!0},{student_signature:Date.now()})}):console.error("currentUserFull is not defined");function I(){var t=[o,a,i].filter((function(t){return t&&t!==e})),n={id_cooperation:window.cooperation_id,date:Date.now(),reading_marker:!1,text:"",id_student:o,id_institution:i,id_employer:a},r=t.map((function(t){return sendNotification(t,n)}));return $.when.apply($,r)}function C(){getCatalogData("COOPERATION",{id:[window.cooperation_id]}).done((function(t){var e=t.result.data&&t.result.data.length&&t.result.data[0];if(e&&e.length){var n=e[1],o=e[19],a=e[18],i=!e[4]||!e[28]||e[20],r="Партнерское соглашение"==n&&o&&a,l="Партнерское соглашение"!=n&&o&&a&&i,d=$(".select__control[name=partner-type-select]").val(),s=Date.now();r||l?$.when(r&&function(t){var e=[t.id_contract,t.contract_date,t.validity,t.id_employer,t.id_institution,t.partnership_status,t.partnership_type],n={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/create?code="+c+"&data="+encodeURIComponent(JSON.stringify(e))+"&unique_request_identifier="+_.uniqueId("PC_"),dataType:"json",contentType:"application/json",method:"POST"};return $.ajax(n)}({id_contract:e[3][0],contract_date:s,validity:e[3][13],id_employer:e[6][0],id_institution:e[5][0],partnership_status:"Активный",partnership_type:d}),setFields(f,w,{contract_concluded:s,status:"Заключен"}),setFields(f,m,{contract_date:s})):setFields(f,w,{status:"На подписании"})}else S()}))}function F(){var e=[],o=$(".upload__control[name=contract_file]"),a=$(".select__control[ref=institute_rating]").val(),i=$(".select__control[ref=employer_rating]").val(),r=$(".text__control[name=description]").val(),c=$(".text__control[name=employer_comment]").val(),l=$(".text__control[name=education_comment]").val(),d=$(".select__control[name=partner-type-select]").val();console.log("--- form data ---"),console.log("fileInput:",o),console.log("selectInputE:",i),console.log("selectInputI:",a),console.log("employerReview:",r),console.log("employerComment:",c),console.log("institutionCommen:",l),console.log("partnershipType:",d);var s,u,p,_="Работодатель"===n,h="Учебное заведение"===n;w.id=window.cooperation_id,w.sortId=window.cooperation_id,console.log(w),console.log(w),g&&o.get(0).files.length&&e.push((s=o.get(0).files,u=t,(p=new FormData).append("typeCode","studDoc"),p.append("attachExtId",createUUID1()),p.append("file",s[0]),p.append("systemCode","intern"),p.append("extId",u),$.ajax({url:"/api/archive/storeAttachment",data:p,contentType:!1,processData:!1,type:"POST"}).then((function(){return console.log("FILE ATTACHED")})).catch((function(t){return console.err(t)})))),_&&r&&e.push(setFields(f,w,{employer_review:r})),_&&c&&e.push(setFields(f,w,{comment_employer:c})),h&&l&&e.push(setFields(f,w,{comment_educational:l})),h&&d&&e.push(setFields(f,w,{partnership_type:d})),a&&e.push(setFields(f,w,{institution_rating:a,institution_rating_setting:Date.now()})),i&&e.push(setFields(f,w,{employer_rating:i,employer_rating_setting:Date.now()})),e.length&&$.when.apply($,e).then(I).then(S).catch(D)}function O(t,e){$("#contract_appruve_info .modal__footer .button").on("click",(function(){m.id=window.contract_id,m.sortId=window.contract_id,w.id=window.cooperation_id,w.sortId=window.cooperation_id,$.when(setFields(f,m,t),setFields(f,w,e)).then(C).then(I).then(S).catch(D)}))}function S(){window.location.reload(!0)}function D(t){console.error(t)}function A(t){var e=t.result.code;if(e!==s)throw new Error("Bad request code:",e);return t}}();