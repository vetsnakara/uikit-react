!function(){var t,e,i=[];currentUser&&(t=JSON.parse(currentUser.externalData||"{}"),e={},_.has(t,"inn")&&!_.isNull(t.inn)&&(e.inn=[t.inn]),_.has(t,"kpp")&&!_.isNull(t.kpp)&&(e.kpp=[t.kpp]),_.has(t,"ogrn")&&!_.isNull(t.ogrn)&&(e.ogrn=[t.ogrn]),_.keys(e).length)&&getCatalogData("INSTITUTION",e).done(function(t){i=t.result.data[0]||[]}),$(document).on("tile-catalog:draw",function(t,e){e=$(e);$("div.modal[role=dialog]",e).off("show.bs.modal").on("show.bs.modal",function(){var a=$(this),n=(a.data("uid"),a.data("file"),$("input[type=file]",a)),o=$("[ref=file-download]",a).data("file");getFileEnum(o).done(function(t){var e,n;_.has(t,"attachs")?(e="/api/archive/download/"+t.attachs[0].file,n=t.attachs[0].fileName,$("[ref=file-download] .file-preview",a).text(n),$("[ref=file-download] a",a).attr("href",e),$("[ref=file-download] a",a).attr("target","_blank"),1<t.attachs.length?t.attachs.forEach(function(t){t.extId===o&&(e="/api/archive/download/"+t.file,n=t.fileName)}):(e="/api/archive/download/"+t.attachs[0].file,n=t.attachs[0].fileName)):(e=o,n="Договор"),$("[ref=file-download] .file-preview",a).text(n),$("[ref=file-download] a",a).attr("href",e),$("[ref=file-download] a",a).attr("target","_blank")}),n.off("change").on("change",function(){$(".upload__file",a).text(n.get(0).files[0].name)}),$("button[ref=contract-create]",e).off("click").on("click",function(){var t,e;t=n.get(0).files,(e=new FormData).append("docDate",moment().format("YYYY-MM-DDT00:00:00")),e.append("docNumber",createUUID1()),e.append("docTypeCode","studDoc"),e.append("extId",createUUID1()),e.append("file",t[0]),e.append("name","Договор оферта"),e.append("nomenclature","string"),e.append("srcSystem","intern"),$.ajax({url:"/api/archive/store",data:e,contentType:!1,processData:!1,type:"POST"}).done(function(t){var e,o={cooperation_type:"Партнерское соглашение",request_code:(e=a).data("uid"),id_institution:i[0],id_employer:e.data("employer"),made_contract:Date.now(),prof_activity_code:e.data("profactivitycode"),code:e.data("code"),interaction_region:e.data("region"),interaction_city:e.data("city"),id_contract:createUUID1(),id_cooperation:createUUID1(),contract_number:$("input[ref=contract-number]",e).val(),contract_date:Date.now(),contract_duration:$("input[ref=contract-duration]",e).val()};o.file=t.extId,$.when((t=[(e=o).id_cooperation,o.cooperation_type,o.request_code,o.id_contract,"",o.id_institution,o.id_employer,"",null,null,"","","",null,null,"Новый",!1,o.made_contract,null,null,null,null,null,null,o.interaction_region,o.interaction_city,o.prof_activity_code,o.code,!1,null,null,"","",!1],e={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=COOPERATION&id="+o.id_cooperation+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(t))+"&version=1.2",dataType:"json",contentType:"application/json",method:"POST"},$.ajax(e)),(e=[(t=o).id_contract,o.contract_number,null,o.id_institution,o.id_employer,"",o.file,!1,!1,!1,o.cooperation_type,o.request_code,o.id_cooperation,o.contract_duration,0],t={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=CONTRACT&id="+o.id_contract+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(e))+"&version=1.2",dataType:"json",contentType:"application/json",method:"POST"},$.ajax(t))).then(function(t,e){var n,a,t={user:currentUserFull.id,employer:o.id_employer,institution:o.id_institution,cooperation:t[0].result.data};return t=[(n=t).student,n.employer,n.institution].filter(function(t){return t&&t!==n.user}),a={id_cooperation:n.cooperation,date:Date.now(),reading_marker:!1,text:"",id_student:n.student,id_institution:n.institution,id_employer:n.employer},t=t.map(function(t){return sendNotification(t,a)}),$.when.apply($,t)}).then(function(){a.modal("hide")}).catch(function(t){console.error(t)})})})})})}();