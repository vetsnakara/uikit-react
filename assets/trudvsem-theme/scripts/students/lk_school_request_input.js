!function(){var t="CONTRACT",e="COOPERATION",n=[];if(currentUser){var a=JSON.parse(currentUser.externalData||"{}"),o={};_.has(a,"inn")&&!_.isNull(a.inn)&&(o.inn=[a.inn]),_.has(a,"kpp")&&!_.isNull(a.kpp)&&(o.kpp=[a.kpp]),_.has(a,"ogrn")&&!_.isNull(a.ogrn)&&(o.ogrn=[a.ogrn]),_.keys(o).length&&getCatalogData("INSTITUTION",o).done((function(t){n=t.result.data[0]||[]}))}$(document).on("tile-catalog:draw",(function(a,o){o=$(o);$("div.modal[role=dialog]",o).off("show.bs.modal").on("show.bs.modal",(function(){var a=$(this),i=(a.data("uid"),a.data("file")),r=$("input[type=file]",a);i=$("[ref=file-download]",a).data("file");getFileEnum(i).done((function(t){var e,n;_.has(t,"attachs")?(e="/api/archive/download/"+t.attachs[0].file,n=t.attachs[0].fileName,$("[ref=file-download] .file-preview",a).text(n),$("[ref=file-download] a",a).attr("href",e),$("[ref=file-download] a",a).attr("target","_blank"),t.attachs.length>1?t.attachs.forEach((function(t){t.extId===i&&(e="/api/archive/download/"+t.file,n=t.fileName)})):(e="/api/archive/download/"+t.attachs[0].file,n=t.attachs[0].fileName)):(e=i,n="Договор"),$("[ref=file-download] .file-preview",a).text(n),$("[ref=file-download] a",a).attr("href",e),$("[ref=file-download] a",a).attr("target","_blank")})),r.off("change").on("change",(function(){$(".upload__file",a).text(r.get(0).files[0].name)})),$("button[ref=contract-create]",o).off("click").on("click",(function(){var o,i;(o=r.get(0).files,i=new FormData,i.append("docDate",moment().format("YYYY-MM-DDT00:00:00")),i.append("docNumber",createUUID1()),i.append("docTypeCode","studDoc"),i.append("extId",createUUID1()),i.append("file",o[0]),i.append("name","Договор оферта"),i.append("nomenclature","string"),i.append("srcSystem","intern"),$.ajax({url:"/api/archive/store",data:i,contentType:!1,processData:!1,type:"POST"})).done((function(o){var i,r={cooperation_type:"Партнерское соглашение",request_code:(i=a).data("uid"),id_institution:n[0],id_employer:i.data("employer"),made_contract:Date.now(),prof_activity_code:i.data("profactivitycode"),code:i.data("code"),interaction_region:i.data("region"),interaction_city:i.data("city"),id_contract:createUUID1(),id_cooperation:createUUID1(),contract_number:$("input[ref=contract-number]",i).val(),contract_date:Date.now(),contract_duration:$("input[ref=contract-duration]",i).val()};r.file=o.extId,$.when(function(t){var n=[t.id_cooperation,t.cooperation_type,t.request_code,t.id_contract,"",t.id_institution,t.id_employer,"",null,null,"","","",null,null,"Новый",!1,t.made_contract,null,null,null,null,null,null,t.interaction_region,t.interaction_city,t.prof_activity_code,t.code,!1,null,null,"","",!1],a="//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code="+e+"&id="+t.id_cooperation+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(n))+"&version=1.2",o={url:a,dataType:"json",contentType:"application/json",method:"POST"};return $.ajax(o)}(r),function(e){var n=[e.id_contract,e.contract_number,null,e.id_institution,e.id_employer,"",e.file,!1,!1,!1,e.cooperation_type,e.request_code,e.id_cooperation,e.contract_duration,0],a="//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code="+t+"&id="+e.id_contract+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(n))+"&version=1.2",o={url:a,dataType:"json",contentType:"application/json",method:"POST"};return $.ajax(o)}(r)).then((function(t,e){return function(t){var e=[t.student,t.employer,t.institution].filter((function(e){return e&&e!==t.user})),n={id_cooperation:t.cooperation,date:Date.now(),reading_marker:!1,text:"",id_student:t.student,id_institution:t.institution,id_employer:t.employer},a=e.map((function(t){return sendNotification(t,n)}));return $.when.apply($,a)}({user:currentUserFull.id,employer:r.id_employer,institution:r.id_institution,cooperation:t[0].result.data})})).then((function(){a.modal("hide")})).catch((function(t){console.error(t)}))}))}))}))}))}();