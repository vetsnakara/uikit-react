$(function(){var e=$("#create_contract"),t="",i={},r={contract_id:createUUID1(),cooperation_id:createUUID1(),contract_number:"",id_institution:"",id_employer:"",id_student:"",contract_url:"",type_of_contract:"",seats_number:null,start_date:"",end_date:"",interaction_region:"",interaction_city:"",prof_activity_code:"",code:"",task:""};new bft_JoinSource({sources:["_partners_source"],initHandler:function(e){e=e._partners_source.url.split("/getData/");t=e[0]},handler:null}),e.off("show.bs.modal").on("show.bs.modal",function(e){var n=$(e.relatedTarget),a=$(this),o=$("input[name=contract_file]",a);o.off("change").on("change",function(){o.closest(".upload").find(".upload__file").text(o.get(0).files[0].name)}),$(".professions__subtitle",a).text(decodeURIComponent(n.data("employername"))),$(".button[rel=submit]",a).off("click").on("click",function(){var e,t;r.id_employer=n.data("employer"),r.id_institution=n.data("institution"),r.id_student=$("select[name=candidade]",a).val()||"",r.contract_number=$("input[name=number]",a).val(),r.type_of_contract=$("select[name=interaction]",a).val(),r.start_date=$("input[name=start_date]",a).val()||"",r.end_date=$("input[name=end_date]",a).val()||"",r.interaction_region=$("select[name=region]",a).val()||"",r.interaction_city=$("select[name=city]",a).val()||"",r.prof_activity_code=$("select[name=profession-area]",a).val()||"",r.code=$("select[name=profession]",a).val()||"",r.task=$("textarea[name=description]",a).val(),moment(r.start_date,"DMY").isValid()&&(r.start_date=moment(r.start_date,"DMY").valueOf()),moment(r.end_date,"DMY").isValid()&&(r.end_date=moment(r.end_date,"DMY").valueOf()),e=o.get(0).files,(t=new FormData).append("docDate",moment().format("YYYY-MM-DDT00:00:00")),t.append("docNumber",createUUID1()),t.append("docTypeCode","studDoc"),t.append("extId",createUUID1()),t.append("file",e[0]),t.append("name","Договор №"+r.contract_number),t.append("nomenclature","string"),t.append("srcSystem","intern"),$.ajax({url:"/api/archive/store",data:t,contentType:!1,processData:!1,type:"POST"}).done(function(e){var t;r.contract_url=e.extId,$.when((t=[(e=r).cooperation_id,e.type_of_contract,"",e.contract_id,e.id_student,e.id_institution,e.id_employer,"",e.start_date,e.end_date,e.task,"",null,"","","Новый","",Date.now(),"","","","","","",e.interaction_region,e.interaction_city,e.prof_activity_code,e.code,!1,null,null,"","",!1],e="//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=COOPERATION&id="+e.cooperation_id+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(t))+"&version=1.2",$.ajax({url:e,dataType:"json",contentType:"application/json",method:"POST"})),(e=[(t=r).contract_id,r.contract_number,null,r.id_institution,r.id_employer,r.id_student,r.contract_url,!1,!1,!1,r.type_of_contract,"",r.cooperation_id,null,r.seats_number],t="//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=CONTRACT&id="+r.contract_id+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(e))+"&version=1.2",$.ajax({url:t,dataType:"json",contentType:"application/json",method:"POST"}))).then(function(e,t){var n,a,e={user:currentUserFull.id,student:r.id_student,employer:r.id_employer,institution:r.id_institution,cooperation:e[0].result.data};return e=[(n=e).student,n.employer,n.institution].filter(function(e){return e&&e!==n.user}),a={id_cooperation:n.cooperation,date:Date.now(),reading_marker:!1,text:"",id_student:n.student,id_institution:n.institution,id_employer:n.employer},e=e.map(function(e){return sendNotification(e,a)}),$.when.apply($,e)}).then(function(){a.modal("hide")}).catch(function(e){console.error(e)}),console.log(r)})}),$.ajax({url:t+"/api/1.2/catalog/data/STUDENT?unique_request_identifier="+_.uniqueId("query_"),type:"GET",dataType:"json"}).done(function(e){$("select[name=candidade]").select2({allowClear:!0,placeholder:"Выберите кандидата",data:e.result.data.map(function(e){return{id:e[0],text:e[1]}})})}),$.ajax({url:"https://test-integration.trudvsem.ru/api/dictionary/get?code=DICT_REGION",type:"GET",dataType:"jsonp"}).done(function(e){$("select[name=region]",a).select2({allowClear:!0,placeholder:"Выберите регион",data:e.map(function(e){return{id:String(e.name),text:String(e.name)}})})}),$("select[name=interaction]",a).select2({allowClear:!0,minimumResultsForSearch:-1,placeholder:"Выберите вид взаимодействия"}),$("select[name=profession-area]").select2({cache:!0,placeholder:"Выберите...",allowClear:!0,ajax:{dataType:"json",url:t+"/api/1.2/catalog/data/ACTIVITY_AREA",data:function(e){var t={unique_request_identifier:_.uniqueId("query_")};return e.term&&e.term.length&&(t.filter=JSON.stringify({name:[String(e.term).toLocaleLowerCase()]})),t},processResults:function(e){return{results:e.result.data.map(function(e){return{cid:e[1],id:e[0],text:e[4]}})}}}}).off("select2:select").on("select2:select",function(e){i=e.params.data,$("select[name=profession]").val(null).trigger("change")}),$("select[name=profession]").select2({cache:!0,placeholder:"Выберите...",allowClear:!0,ajax:{dataType:"json",url:t+"/api/1.2/catalog/data/DEMANDED_PROFESSIONS",data:function(e){var t={profActivityCode:[i.cid]};return e.term&&e.term.length&&(t.name=[String(e.term).toLocaleLowerCase()]),{unique_request_identifier:_.uniqueId("query_"),filter:JSON.stringify(t)}},processResults:function(e){return{results:e.result.data.map(function(e){return{cid:e[1],id:e[0],text:e[3]}})}}}})})});