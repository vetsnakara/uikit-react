$((function(){var e=$("#create_contract"),t="",n={},a={contract_id:createUUID1(),cooperation_id:createUUID1(),contract_number:"",id_institution:"",id_employer:"",id_student:"",contract_url:"",type_of_contract:"",seats_number:null,start_date:"",end_date:"",interaction_region:"",interaction_city:"",prof_activity_code:"",code:"",task:""};new bft_JoinSource({sources:["_partners_source"],initHandler:function(e){var n=e._partners_source.url.split("/getData/");t=n[0]},handler:null}),e.off("show.bs.modal").on("show.bs.modal",(function(e){var o=$(e.relatedTarget),i=$(this),r=$("input[name=contract_file]",i);r.off("change").on("change",(function(){r.closest(".upload").find(".upload__file").text(r.get(0).files[0].name)})),$(".professions__subtitle",i).text(decodeURIComponent(o.data("employername"))),$(".button[rel=submit]",i).off("click").on("click",(function(){var e,t;a.id_employer=o.data("employer"),a.id_institution=o.data("institution"),a.id_student=$("select[name=candidade]",i).val()||"",a.contract_number=$("input[name=number]",i).val(),a.type_of_contract=$("select[name=interaction]",i).val(),a.start_date=$("input[name=start_date]",i).val()||"",a.end_date=$("input[name=end_date]",i).val()||"",a.interaction_region=$("select[name=region]",i).val()||"",a.interaction_city=$("select[name=city]",i).val()||"",a.prof_activity_code=$("select[name=profession-area]",i).val()||"",a.code=$("select[name=profession]",i).val()||"",a.task=$("textarea[name=description]",i).val(),moment(a.start_date,"DMY").isValid()&&(a.start_date=moment(a.start_date,"DMY").valueOf()),moment(a.end_date,"DMY").isValid()&&(a.end_date=moment(a.end_date,"DMY").valueOf()),(e=r.get(0).files,t=new FormData,t.append("docDate",moment().format("YYYY-MM-DDT00:00:00")),t.append("docNumber",createUUID1()),t.append("docTypeCode","studDoc"),t.append("extId",createUUID1()),t.append("file",e[0]),t.append("name","Договор №"+a.contract_number),t.append("nomenclature","string"),t.append("srcSystem","intern"),$.ajax({url:"/api/archive/store",data:t,contentType:!1,processData:!1,type:"POST"})).done((function(e){a.contract_url=e.extId,$.when(function(e){var t=[e.cooperation_id,e.type_of_contract,"",e.contract_id,e.id_student,e.id_institution,e.id_employer,"",e.start_date,e.end_date,e.task,"",null,"","","Новый","",Date.now(),"","","","","","",e.interaction_region,e.interaction_city,e.prof_activity_code,e.code,!1,null,null,"","",!1],n={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=COOPERATION&id="+e.cooperation_id+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(t))+"&version=1.2",dataType:"json",contentType:"application/json",method:"POST"};return $.ajax(n)}(a),function(e){var t=[e.contract_id,e.contract_number,null,e.id_institution,e.id_employer,e.id_student,e.contract_url,!1,!1,!1,e.type_of_contract,"",e.cooperation_id,null,e.seats_number],n={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=CONTRACT&id="+e.contract_id+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(t))+"&version=1.2",dataType:"json",contentType:"application/json",method:"POST"};return $.ajax(n)}(a)).then((function(e,t){return function(e){var t=[e.student,e.employer,e.institution].filter((function(t){return t&&t!==e.user})),n={id_cooperation:e.cooperation,date:Date.now(),reading_marker:!1,text:"",id_student:e.student,id_institution:e.institution,id_employer:e.employer},a=t.map((function(e){return sendNotification(e,n)}));return $.when.apply($,a)}({user:currentUserFull.id,student:a.id_student,employer:a.id_employer,
//! bug(?): button.data("employer") === undefined для 1ой ссылки "Создать договор"
institution:a.id_institution,cooperation:e[0].result.data})})).then((function(){i.modal("hide")})).catch((function(e){console.error(e)})),console.log(a)}))})),$.ajax({url:t+"/api/1.2/catalog/data/STUDENT?unique_request_identifier="+_.uniqueId("query_"),type:"GET",dataType:"json"}).done((function(e){$("select[name=candidade]").select2({allowClear:!0,placeholder:"Выберите кандидата",data:e.result.data.map((function(e){return{id:e[0],text:e[1]}}))})})),$.ajax({url:"https://test-integration.trudvsem.ru/api/dictionary/get?code=DICT_REGION",type:"GET",dataType:"jsonp"}).done((function(e){$("select[name=region]",i).select2({allowClear:!0,placeholder:"Выберите регион",data:e.map((function(e){return{id:String(e.name),text:String(e.name)}}))})})),$("select[name=interaction]",i).select2({allowClear:!0,minimumResultsForSearch:-1,placeholder:"Выберите вид взаимодействия"}),$("select[name=profession-area]").select2({cache:!0,placeholder:"Выберите...",allowClear:!0,ajax:{dataType:"json",url:t+"/api/1.2/catalog/data/ACTIVITY_AREA",data:function(e){var t={unique_request_identifier:_.uniqueId("query_")};return e.term&&e.term.length&&(t.filter=JSON.stringify({name:[String(e.term).toLocaleLowerCase()]})),t},processResults:function(e){return{results:e.result.data.map((function(e){return{cid:e[1],id:e[0],text:e[4]}}))}}}}).off("select2:select").on("select2:select",(function(e){n=e.params.data,$("select[name=profession]").val(null).trigger("change")})),$("select[name=profession]").select2({cache:!0,placeholder:"Выберите...",allowClear:!0,ajax:{dataType:"json",url:t+"/api/1.2/catalog/data/DEMANDED_PROFESSIONS",data:function(e){var t={profActivityCode:[n.cid]};return e.term&&e.term.length&&(t.name=[String(e.term).toLocaleLowerCase()]),{unique_request_identifier:_.uniqueId("query_"),filter:JSON.stringify(t)}},processResults:function(e){return{results:e.result.data.map((function(e){return{cid:e[1],id:e[0],text:e[3]}}))}}}})}))}));