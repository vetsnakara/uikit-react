$((function(){var e=$("#create_contract"),t="",n={},a={contract_id:createUUID1(),cooperation_id:createUUID1(),contract_number:"",id_institution:"",id_employer:"",id_student:"",contract_url:"",type_of_contract:"",seats_number:null,start_date:"",end_date:"",interaction_region:"",interaction_city:"",prof_activity_code:"",code:"",task:"",students:[]};new bft_JoinSource({sources:["_partners_source"],initHandler:function(e){var n=e._partners_source.url.split("/getData/");t=n[0]},handler:null}),e.off("show.bs.modal").on("show.bs.modal",(function(e){var i=$(e.relatedTarget),r=$(this),o=$("input[name=contract_file]",r);o.off("change").on("change",(function(){o.closest("label").find(".upload__file").text(o.get(0).files[0].name)})),$(".professions__subtitle",r).text(decodeURIComponent(i.data("employername"))),$("button[rel=submit]",r).off("click").on("click",(function(){var e,t;a.id_employer=i.data("employer"),a.id_institution=i.data("institution"),a.id_student=$("select[name=candidade]",r).val()||"",a.contract_number=$("input[name=number]",r).val(),a.type_of_contract=$("select[name=interaction]",r).val(),a.start_date=$("input[name=start_date]",r).val()||"",a.end_date=$("input[name=end_date]",r).val()||"",a.interaction_region=$("select[name=region]",r).val()||"",a.interaction_city=$("select[name=city]",r).val()||"",a.prof_activity_code=$("select[name=profession-area]",r).val()||"",a.code=$("select[name=profession]",r).val()||"",_.isArray(a.id_student)&&a.id_student.length&&(a.students=_.range(1,a.id_student.length).map((function(e){return a.id_student[e].split(",")[1]})),a.id_student=a.id_student[0].split(",")[0]),moment(a.start_date,"DMY").isValid()&&(a.start_date=moment(a.start_date,"DMY").valueOf()),moment(a.end_date,"DMY").isValid()&&(a.end_date=moment(a.end_date,"DMY").valueOf()),a.required_student_signature=!(a.students.length>0)&&($("input[name=required_student_signature]",r).is(":checked")||!1),(e=o.get(0).files,t=new FormData,t.append("docDate",moment().format("YYYY-MM-DDT00:00:00")),t.append("docNumber",createUUID1()),t.append("docTypeCode","studDoc"),t.append("extId",createUUID1()),t.append("file",e[0]),t.append("name","Договор №"+a.contract_number),t.append("nomenclature","string"),t.append("srcSystem","intern"),$.ajax({url:"/api/archive/store",data:t,contentType:!1,processData:!1,type:"POST"})).done((function(e){a.contract_url=e.extId,$.when(function(e){var t=[e.cooperation_id,e.type_of_contract,"",e.contract_id,e.id_student,e.id_institution,e.id_employer,"",e.start_date,e.end_date,e.task,"",null,"","","Новый","",Date.now(),"","","","","","",e.interaction_region,e.interaction_city,e.prof_activity_code,e.code,e.required_student_signature,null,e.students,"","",!1],n={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=COOPERATION&id="+e.cooperation_id+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(t))+"&version=1.2",dataType:"json",contentType:"application/json",method:"POST"};return $.ajax(n)}(a),function(e){var t=[e.contract_id,e.contract_number,null,e.id_institution,e.id_employer,e.id_student,e.contract_url,!1,!1,!1,e.type_of_contract,"",e.cooperation_id,null,e.seats_number],n={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/store?code=CONTRACT&id="+e.contract_id+"&unique_request_identifier="+_.uniqueId("COOPERATION_CATALOG_")+"&data="+encodeURIComponent(JSON.stringify(t))+"&version=1.2",dataType:"json",contentType:"application/json",method:"POST"};return $.ajax(n)}(a)).then((function(e,t){var n={user:currentUserFull.id,student:a.id_student,employer:a.id_employer,institution:a.id_institution,cooperation:e[0].result.data};return console.log(n),function(e){var t=[e.student,e.employer,e.institution].filter((function(t){return t&&t!==e.user})),n={id_cooperation:e.cooperation,date:Date.now(),reading_marker:!1,text:"",id_student:e.student,id_institution:e.institution,id_employer:e.employer},a=t.map((function(e){return sendNotification(e,n)}));return $.when.apply($,a)}(n)})).then((function(){r.modal("hide")})).catch((function(e){console.err(e)})),console.log(a)}))})),$("select[name=interaction]",r).select2({allowClear:!0,minimumResultsForSearch:-1,placeholder:"Выберите вид взаимодействия"}),$.ajax({url:t+"/api/1.2/catalog/data/STUDENT?filter="+encodeURIComponent(JSON.stringify({id_institution:[currentUserFull.id]}))+"&unique_request_identifier="+_.uniqueId("query_"),type:"GET",dataType:"json"}).done((function(e){var t=$("select[name=candidade]",r);t.select2({allowClear:!0,placeholder:"Выберите кандидата",data:e.result.data.map((function(e){return{id:[e[0],e[1]],text:e[1]}}))}),t.on("change",(function(){var e=$("input[name=required_student_signature]",r),n=t.val();_.isArray(n)&&n.length>1?(e.removeAttr("checked"),e.attr("disabled","disabled")):e.removeAttr("disabled")}))})),$.ajax({url:"https://test-integration.trudvsem.ru/api/dictionary/get?code=DICT_REGION",type:"GET",dataType:"jsonp"}).done((function(e){$("select[name=region]",r).select2({allowClear:!0,placeholder:"Выберите регион",data:e.map((function(e){return{id:String(e.name),text:String(e.name)}}))})})),$("select[name=profession-area]").select2({cache:!0,placeholder:"Выберите...",allowClear:!0,ajax:{dataType:"json",url:t+"/api/1.2/catalog/data/ACTIVITY_AREA",data:function(e){var t={unique_request_identifier:_.uniqueId("query_")};return e.term&&e.term.length&&(t.filter=JSON.stringify({name:[String(e.term).toLocaleLowerCase()]})),t},processResults:function(e){return{results:e.result.data.map((function(e){return{cid:e[1],id:e[0],text:e[4]}}))}}}}).off("select2:select").on("select2:select",(function(e){n=e.params.data,$("select[name=profession]").val(null).trigger("change")})),$("select[name=profession]").select2({cache:!0,placeholder:"Выберите...",allowClear:!0,ajax:{dataType:"json",url:t+"/api/1.2/catalog/data/DEMANDED_PROFESSIONS",data:function(e){var t={profActivityCode:[n.cid]};return e.term&&e.term.length&&(t.name=[String(e.term).toLocaleLowerCase()]),{unique_request_identifier:_.uniqueId("query_"),filter:JSON.stringify(t)}},processResults:function(e){return{results:e.result.data.map((function(e){return{cid:e[1],id:e[0],text:e[3]}}))}}}})}));var i=function(e){var t=$(this),n=$(e.relatedTarget);t.find("[data-content=partnership-partner]").text(n.data("partnership-partner")),t.find("[data-action=contract-delete]").on("click",(function(){var e,t;e=n.data("partnership-id"),t={url:"//test-portal.trudvsem.ru/information/catalogprovider/api/1.2/catalog/delete?code=PARTNERSHIP&id="+e+"&unique_request_identifier="+_.uniqueId("PARTNERSHIP_")+"&version=1.2",dataType:"json",contentType:"application/json",method:"DELETE"},$.ajax(t).done((function(){document.location.reload(!0)}))}))};$("body").off("show.bs.modal","#delete-modal",i).on("show.bs.modal","#delete-modal",i)}));